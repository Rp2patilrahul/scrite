# Setting up Crashpad for use with Scrite

Crashpad is part of Google's Chromium project. It is used for detecting application
crashes, so that appropriate log files may be sent back to us for further investigation.

The source code and build system for crashpad is not bundled as a part of Scrite's 
code itself, and it must built or installed separately. 

In this file we describe the simplest way to setup crashpad for use with Scrite for 
each of the supported platforms.

If you face any issues, please post a topic on the #questions channel in our Discord 
community. **Please DO NOT** send an email, or post a question on any of our YouTube videos,
or on X by tagging us. The only place we will respond to questions is if its posted on
the #questions tab in our Discord channel.

## Setting up crashpad on Windows

### Requirements

- Windows 10 or Windows 11
- Visual Studio 2019
- Windows SDK 10.0.22000.0 or later
- Latest Qt 5.15 LTS (which is 5.15.17 as of writing) for Visual Studio 2019

### Step 1: Install crashpad-binaries

Prebuilt binaries for Visual Studio 2019 are already available at https://github.com/gavv/crashpad-binaries.
We are simply going to clone this repository and use the binaries provided it in.

Open a Command Prompt window and execute the following commands

    mkdir C:\Crashpad
    cd C:\Crashpad
    git clone https://github.com/gavv/crashpad-binaries.git
    
Once the cloning completes, you will notice a `C:\Crashpad\crashpad-binaries` folder. But it will not have
any binaries, since they are available in a separate branch.

    cd C:\Crashpad\crashpad-binaries
    git switch -c VS2019_MD remotes/origin/VS2019_MD
    
This time, when you view the contents of the the `C:\Crashpad\crashpad-binaries` folder, you will notice 
three subfolders `bin`, `lib`, and `include`.

### Step 2: Create SCRITE_CRASHPAD_ROOT environment variable

Open PowerShell as an administrator.

- Hit Win+X
- Select Terminal (Admin) or Windows PowerShell (Admin)
- Execute the following command
    
    `[Environment]::SetEnvironmentVariable("SCRITE_CRASHPAD_ROOT", "C:\Crashpad\crashpad-binaries", "User")`
    
This will cause `crashpad.pri` folder to automatically pick up crashpad binaries for Windows from the 
`C:\Crashpad\crashpad-binaries` folder, and link it with Scrite.

### Step 3: Rebuild Scrite from scratch

Restart Qt Creator, rebuild Scrite from scratch. This time the Scrite project will detect
the availability of crashpad and build accordingly.

### Analyzing Crashpad Dump Files on Windows

You can use WinDbg to load the .dmp files generated by Crashpad and analyze it. Keep the appropriate version of Scrite source code and build handy.

The following links provide information about how to analyze a crashdump generated by Crashpad.

https://www.wikihow.com/Read-Dump-Files

https://www.chromium.org/developers/how-tos/debugging-on-windows/#TOC-Debugging-with-WinDBG

https://www.chromium.org/developers/how-tos/debugging-on-windows/example-of-working-with-a-dump/

## Setting up crashpad on macOS

### Requirements

- macOS Sonoma 14.5 or higher
- Xcode 15.4 or higher
- Latest Qt 5.15 LTS (which is 5.15.17 as of writing)

### Step 1: Install crashpad-binaries

Prebuilt binaries for macOS are already available at https://github.com/gavv/crashpad-binaries.
We are simply going to clone this repository and use the binaries provided it in.

Open a Command Prompt window and execute the following commands

    mkdir $HOME/Crashpad
    cd $HOME/Crashpad
    git clone https://github.com/gavv/crashpad-binaries.git
    
Once the cloning completes, you will notice a `$HOME/Crashpad/crashpad-binaries` folder. But it will not have
any binaries, since they are available in a separate branch.

    cd $HOME/Crashpad/crashpad-binaries
    git switch -c macos remotes/origin/macos
    
This time, when you view the contents of the the `$HOME/Crashpad/crashpad-binaries` folder, you will notice 
three subfolders `bin`, `lib`, and `include`.

### Step 2: Create SCRITE_CRASHPAD_ROOT environment variable

- Open Terminal
- Execute the following command

    `echo "export SCRITE_CRASHPAD_ROOT=$HOME/Crashpad/crashpad-binaries" >> ~/.zshrc`
    
This will cause `crashpad.pri` folder to automatically pick up crashpad binaries for macOS from the 
`$HOME/Crashpad/crashpad-binaries` folder, and link it with Scrite.

It pays to also add the `bin` subfolder in crashpad-binaries to `PATH`

    `echo "export PATH=$SCRITE_CRASHPAD_ROOT/bin:$PATH" >> ~/.zshrc`

To analyse crash-dumps, the symbol file for Scrite has to be generated using `dump_syms`. For this, you will need build `dump_syms` from source code. 

Further, you will need to use `minidump_stackwalk` for extracting stack trace from your crash report. 

For this, first install Homebrew if you have not already done. (https://brew.sh/)

Then, open the Terminal app and execute the following commands one after the other.

    cd $HOME/Crashpad
    brew install autoconf automake libtool
    git clone https://chromium.googlesource.com/breakpad/breakpad
    git clone https://chromium.googlesource.com/linux-syscall-support breakpad/src/third_party/lss
    cd breakpad
    ./configure
    make
    ln -s $HOME/Crashpad/breakpad/src/processor/minidump_stackwalk $HOME/Crashpad/crashpad-binaries/bin/minidump_stackwalk
    cd $HOME/Crashpad/breakpad/src/tools/mac/dump_syms
    xcodebuild -project dump_syms.xcodeproj -configuration Release
    ln -s $HOME/Crashpad/breakpad/src/tools/mac/dump_syms/build/Release/dump_syms $HOME/Crashpad/crashpad-binaries/bin/dump_syms
    
### Step 3: Rebuild Scrite from scratch

Restart your Mac (or atleast logout and log back in), Start Qt Creator, rebuild Scrite from scratch. 
This time the Scrite project will detect the availability of crashpad and build accordingly.

### Analyzing Crashpad Dump Files on Windows

Analyze minidumps using the following commands

    $SCRITE_CRASHPAD_ROOT/bin/minidump_stackwalk /path/to/crash.dmp /path/to/Scrite.app.sym > crash_report.txt

## Setting up crashpad on Linux


